<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FTC Event OPR Rankings</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style id="theme-style">
    :root {
      font-family: 'Inter', sans-serif;
    }
    body {
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      margin-top: 20px;
      font-size: 28px;
    }
    .input-container {
      margin: 20px 0;
    }
    input, select, button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #333;
      background-color: #1e1e1e;
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
    }
    input::placeholder {
      text-align: center;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: #1e1e1e;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: center;
    }
    th {
      background-color: #292929;
    }
    tr:nth-child(even) {
      background-color: #1b1b1b;
    }
    .rank-green {
      color: #00e676;
      font-weight: bold;
    }
    .rank-yellow {
      color: #ffeb3b;
      font-weight: bold;
    }
    .rank-orange {
      color: #ff9800;
      font-weight: bold;
    }
    .highlight-team {
      outline: 2px solid #bb86fc;
      outline-offset: -2px;
      background-color: #2a2a2a !important;
    }
    #theme-toggle {
      position: absolute;
      right: 20px;
      top: 20px;
    }
    .popup-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    .popup {
      background-color: #1e1e1e;
      color: white;
      padding: 10px 20px;
      border: 1px solid #bb86fc;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 300px;
    }
    .popup span {
      flex: 1;
      text-align: center;
    }
    .popup button {
      background-color: #bb86fc;
      border: none;
      border-radius: 5px;
      color: black;
      font-weight: bold;
      padding: 5px 10px;
      cursor: pointer;
    }
    .info {
      margin: 5px 0 15px;
      font-size: 16px;
      color: #ccc;
    }
    #footer {
      margin: 30px;
      font-size: 14px;
      color: #888;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
  <h1 id="event-title">FTC Event OPR Rankings</h1>
  <div class="info" id="event-info"></div>

  <div class="input-container">
    <input type="text" id="eventCode" placeholder="Enter event code">
    <select id="year">
      <option value="2024">2024 - Into the Deep</option>
      <option value="2023">2023 - Centerstage</option>
      <option value="2022">2022 - Power Play</option>
      <option value="2021">2021 - Freight Frenzy</option>
    </select>
    <select id="sortBy">
      <option value="tot">Total OPR</option>
      <option value="auto">Auto OPR</option>
      <option value="dc">Teleop OPR</option>
      <option value="eg">Endgame OPR</option>
    </select>
    <button onclick="loadData()">Load Rankings</button>
    <button onclick="showHighlightPopup()">Highlight Team</button>
    <div id="loading"></div>
  </div>

  <table id="rankings">
    <thead>
      <tr>
        <th>#</th>
        <th>Team</th>
        <th>Location</th>
        <th>Total</th>
        <th>Auto</th>
        <th>Teleop</th>
        <th>Endgame</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="info" id="total-teams"></div>
  <div class="popup-container" id="popup-container"></div>
  <div id="footer">Powered by FTCScout API</div>

  <script>
    let currentTheme = 'dark';
    let cachedData = null;
    let highlightedTeam = null;

    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      const bg = currentTheme === 'dark' ? '#121212' : '#f0f0f0';
      const fg = currentTheme === 'dark' ? '#e0e0e0' : '#111';

      document.body.style.backgroundColor = bg;
      document.body.style.color = fg;
      document.querySelectorAll("input, select, button, table, th, td").forEach(el => {
        el.style.backgroundColor = '#1e1e1e';
        el.style.color = '#e0e0e0';
      });
    }

    function addPopup(message, buttonText = "Dismiss", onDismiss = null) {
      const container = document.getElementById("popup-container");
      const popup = document.createElement("div");
      popup.className = "popup";
      popup.innerHTML = `<span>${message}</span><button>${buttonText}</button>`;
      popup.querySelector("button").onclick = () => {
        popup.remove();
        if (onDismiss) onDismiss();
      };
      container.appendChild(popup);
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
      return await res.json();
    }

    async function loadData() {
      const code = document.getElementById('eventCode').value.trim();
      const year = document.getElementById('year').value;
      const sortBy = document.getElementById('sortBy').value;
      const tbody = document.querySelector('#rankings tbody');
      tbody.innerHTML = "";
      highlightedTeam = null;
      document.getElementById("popup-container").innerHTML = "";

      try {
        const event = await fetchJSON(`https://api.ftcscout.org/rest/v1/events/${year}/${code}`);
        document.getElementById("event-title").textContent = `${event.name} OPR Rankings`;
        document.getElementById("event-info").textContent = `${event.city}, ${event.state}, ${event.country} | ${event.start} - ${event.end}`;
        const teams = await fetchJSON(`https://api.ftcscout.org/rest/v1/events/${year}/${code}/teams`);
        const teamStats = [];

        for (const team of teams) {
          const num = team.teamNumber;
          const info = await fetchJSON(`https://api.ftcscout.org/rest/v1/teams/${num}/`);
          const stats = await fetchJSON(`https://api.ftcscout.org/rest/v1/teams/${num}/quick-stats?season=${year}`);

          const format = (obj, key) => obj[key] ? {
            value: obj[key].value,
            rank: obj[key].rank,
            display: `${obj[key].value.toFixed(2)} (${obj[key].rank})`
          } : { display: "N/A" };

          const location = [info.city, info.state, info.country].filter(Boolean).join(', ');
          teamStats.push({
            teamNumber: num,
            name: info.name ?? "Unknown",
            location: location || "Unknown",
            values: {
              tot: format(stats, 'tot'),
              auto: format(stats, 'auto'),
              dc: format(stats, 'dc'),
              eg: format(stats, 'eg')
            }
          });
        }

        cachedData = teamStats;
        renderTable(sortBy);
        addPopup(`Finished scouting ${event.name}`);
      } catch (e) {
        console.error(e);
        addPopup("Event not found or error loading.");
      }
    }

    function renderTable(sortBy) {
      const tbody = document.querySelector('#rankings tbody');
      tbody.innerHTML = "";

      let data = [...cachedData].filter(Boolean);
      if (highlightedTeam) {
        const highlightEntry = data.find(t => t.teamNumber == highlightedTeam);
        data = data.filter(t => t.teamNumber != highlightedTeam);
        if (highlightEntry) data.unshift(highlightEntry);
      }

      data.sort((a, b) => (b.values[sortBy]?.value || 0) - (a.values[sortBy]?.value || 0));

      const getClass = rank => {
        if (!rank) return "";
        if (rank <= 100) return "rank-green";
        if (rank <= 250) return "rank-yellow";
        if (rank <= 500) return "rank-orange";
        return "";
      };

      for (const t of data) {
        const row = document.createElement("tr");
        if (t.teamNumber == highlightedTeam) row.classList.add("highlight-team");
        row.innerHTML = `
          <td>${t.values[sortBy]?.rank ?? "-"}</td>
          <td><a href="https://ftcscout.org/teams/${t.teamNumber}" target="_blank">#${t.teamNumber} - ${t.name}</a></td>
          <td>${t.location}</td>
          <td class="${getClass(t.values.tot?.rank)}">${t.values.tot.display}</td>
          <td class="${getClass(t.values.auto?.rank)}">${t.values.auto.display}</td>
          <td class="${getClass(t.values.dc?.rank)}">${t.values.dc.display}</td>
          <td class="${getClass(t.values.eg?.rank)}">${t.values.eg.display}</td>
        `;
        tbody.appendChild(row);
      }

      document.getElementById("total-teams").textContent = `Total Teams Scouted: ${cachedData.length}`;
    }

    function showHighlightPopup() {
      const container = document.getElementById("popup-container");
      const popup = document.createElement("div");
      popup.className = "popup";
      popup.innerHTML = `
        <input type="number" id="highlightInput" placeholder="Team #">
        <button>Highlight Team</button>
      `;
      popup.querySelector("button").onclick = () => {
        const val = document.getElementById("highlightInput").value;
        if (!val) return;
        highlightedTeam = val;
        renderTable(document.getElementById("sortBy").value);
        popup.remove();
        addPopup(`Currently highlighting team ${val}`, "Dismiss", () => {
          highlightedTeam = null;
          renderTable(document.getElementById("sortBy").value);
        });
      };
      container.appendChild(popup);
    }
  </script>
</body>
</html>
