<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC OPR Rankings</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    h1 {
      font-size: 28px;
    }
    .progress {
      margin-top: 10px;
      font-size: 14px;
    }
    table {
      margin: 30px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 1000px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
    }
    th {
      background-color: #222;
    }
    .highlight {
      background-color: #800080;
      font-weight: bold;
    }
    a {
      color: #00aaff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .event-details {
      font-size: 14px;
      color: #aaa;
    }
    .input-container {
      margin-top: 20px;
    }
    input[type="text"] {
      padding: 5px;
      font-size: 16px;
      width: 300px;
    }
    button {
      padding: 5px 10px;
      font-size: 16px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>FTC OPR Rankings</h1>
  <div class="input-container">
    <input type="text" id="eventKeyInput" placeholder="Enter Event Key" />
    <button onclick="loadRankings()">Load Event</button>
  </div>
  <div class="progress" id="progressBar"></div>
  <table id="rankingTable" style="display: none;">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Team</th>
        <th>np OPR</th>
        <th>Auto OPR</th>
        <th>Teleop OPR</th>
        <th>np AVG</th>
        <th>Event</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const statType = "np";
    const statLabel = {
      tot: "np OPR",
      auto: "Auto OPR",
      tele: "Teleop OPR",
      end: "Endgame OPR",
      avg: "np AVG"
    };

    const suffix = (n) => {
      if (n % 100 >= 11 && n % 100 <= 13) return `${n}th`;
      return `${n}${["th","st","nd","rd"][n%10] || "th"}`;
    };

    async function loadRankings() {
      const eventKey = document.getElementById("eventKeyInput").value.trim();
      if (!eventKey) {
        alert("Please enter an event key.");
        return;
      }

      const title = document.querySelector("h1");
      const progress = document.getElementById("progressBar");
      const tbody = document.querySelector("#rankingTable tbody");
      const table = document.getElementById("rankingTable");

      title.innerText = "Loading...";
      progress.innerText = "";
      tbody.innerHTML = "";
      table.style.display = "none";

      try {
        const res = await fetch(`https://api.ftcscout.org/rest/v1/events/${eventKey}`);
        if (!res.ok) throw new Error("Event not found");
        const eventData = await res.json();
        title.innerText = eventData.name;

        const start = new Date(eventData.startDate);
        const end = new Date(eventData.endDate);
        const dateStr = `${(start.getMonth()+1).toString().padStart(2, '0')}/${start.getDate().toString().padStart(2, '0')}/${start.getFullYear()} - ${(end.getMonth()+1).toString().padStart(2, '0')}/${end.getDate().toString().padStart(2, '0')}/${end.getFullYear()}`;

        const locationLink = `<a href="https://maps.google.com/?q=${encodeURIComponent(eventData.location)}" target="_blank">${eventData.location}</a>`;
        const websiteLink = eventData.website ? `<br><a href="${eventData.website}" target="_blank">${eventData.website}</a>` : "";

        const oprRes = await fetch(`https://api.ftcscout.org/rest/v1/events/${eventKey}/opr`);
        const oprData = await oprRes.json();

        const allTeams = new Set(Object.keys(oprData["tot"] || {}));
        ["auto", "tele", "end", "avg"].forEach(k => {
          if (oprData[k]) Object.keys(oprData[k]).forEach(t => allTeams.add(t));
        });

        const teams = Array.from(allTeams);
        const processed = [];

        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];
          progress.innerText = `Processing ${i+1} / ${teams.length} Teams\nCurrently processing ${team}`;

          try {
            const res = await fetch(`https://api.ftcscout.org/rest/v1/teams/${team}`);
            const { name } = await res.json();
            const row = document.createElement("tr");

            const ranking = {
              tot: oprData.tot?.[team]?.rank,
              auto: oprData.auto?.[team]?.rank,
              tele: oprData.tele?.[team]?.rank,
              end: oprData.end?.[team]?.rank,
              avg: oprData.avg?.[team]?.rank
            };

            const scores = {
              tot: oprData.tot?.[team]?.opr,
              auto: oprData.auto?.[team]?.opr,
              tele: oprData.tele?.[team]?.opr,
              end: oprData.end?.[team]?.opr,
              avg: oprData.avg?.[team]?.opr
            };

            const teamRank = ranking[statType];
            const rankCell = document.createElement("td");
            rankCell.innerText = teamRank ? suffix(teamRank) : "-";
            row.appendChild(rankCell);

            const teamCell = document.createElement("td");
            teamCell.innerHTML = `<a href="https://ftcscout.org/teams/${team}" target="_blank">#${team} - ${name}</a>`;
            row.appendChild(teamCell);

            ["tot", "auto", "tele", "avg"].forEach(k => {
              const cell = document.createElement("td");
              if (scores[k] != null) {
                cell.innerText = `${scores[k].toFixed(2)} (${suffix(ranking[k])})`;
                if (k === statType) cell.classList.add("highlight");
              } else {
                cell.innerText = "No Statistics Available";
              }
              row.appendChild(cell);
            });

            const eventCell = document.createElement("td");
            eventCell.innerHTML = `${eventData.name}<div class="event-details">${dateStr}<br>${locationLink}${websiteLink}</div>`;
            row.appendChild(eventCell);

            processed.push({ rank: teamRank ?? Infinity, row });
          } catch {
            // skip on error
          }
        }

        processed.sort((a, b) => a.rank - b.rank);
        processed.forEach(t => tbody.appendChild(t.row));
        progress.innerText = `Total Teams Scouted: ${teams.length}`;
        table.style.display = "table";
      } catch (error) {
        title.innerText = "FTC OPR Rankings";
        progress.innerText = `Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
