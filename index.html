<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTC Event Rankings</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 {
      color: #bb86fc;
      text-align: center;
    }
    .input-container {
      margin-bottom: 2rem;
      text-align: center;
    }
    input {
      padding: 0.5rem;
      margin: 0.2rem;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #bb86fc;
      color: #121212;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    table {
      width: 100%;
      max-width: 900px;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.75rem;
      text-align: center;
    }
    th {
      background-color: #1f1f1f;
    }
    .highlight {
      color: #bb86fc;
      font-weight: bold;
    }
    a {
      color: #bb86fc;
      text-decoration: none;
    }
    .info {
      margin-top: 1rem;
      text-align: center;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1 id="title">FTC Event Rankings</h1>
  <div class="input-container">
    <input id="eventCode" placeholder="Event Code" />
    <input id="year" placeholder="Year" value="2024" />
    <select id="sortMethod">
      <option value="tot">Total</option>
      <option value="auto">Auto</option>
      <option value="dc">TeleOP</option>
      <option value="eg">Endgame</option>
    </select>
    <button onclick="loadData()">Load Rankings</button>
  </div>

  <div id="progress" class="info"></div>
  <div class="info" id="eventInfo"></div>
  <table id="rankings"></table>

  <script>
    function toOrdinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch " + url);
      return res.json();
    }

    async function loadData() {
      const eventCode = document.getElementById("eventCode").value;
      const year = document.getElementById("year").value;
      const sortMethod = document.getElementById("sortMethod").value;

      const sortDisplay = {
        tot: "Total",
        auto: "Auto",
        dc: "TeleOP",
        eg: "Endgame"
      }[sortMethod];

      document.getElementById("rankings").innerHTML = "";
      document.getElementById("eventInfo").textContent = "";

      const eventData = await fetchJSON(`https://api.ftcscout.org/rest/v1/events/${year}/${eventCode}/`);
      const eventName = eventData.name || "Unknown Event";
      const startDate = new Date(eventData.start).toLocaleDateString();
      const endDate = new Date(eventData.end).toLocaleDateString();
      const venue = eventData.venue || "";
      const address = `${eventData.address || ''}, ${eventData.city || ''}, ${eventData.state || ''}, ${eventData.country || ''}`;
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
      const livestream = eventData.livestreamURL;

      document.getElementById("title").textContent = `${eventName}`;
      document.getElementById("eventInfo").innerHTML = `
        Dates: ${startDate} - ${endDate}<br>
        <a href="${mapsLink}" target="_blank">Google Maps</a><br>
        ${livestream ? `<a href="${livestream}" target="_blank">Watch Livestream</a><br>` : ""}
      `;

      const teams = await fetchJSON(`https://api.ftcscout.org/rest/v1/events/${year}/${eventCode}/teams`);

      const teamStatsList = [];

      for (let i = 0; i < teams.length; i++) {
        const team = teams[i];
        const teamNumber = team.teamNumber;

        document.getElementById("progress").innerHTML = `
          Teams Processed: ${i} / ${teams.length}<br>
          Currently Processing: #${teamNumber}
        `;

        let name = "Unknown";
        try {
          const teamDetails = await fetchJSON(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}/`);
          name = teamDetails?.name || "Unknown";
        } catch {}

        document.getElementById("progress").innerHTML = `
          Teams Processed: ${i + 1} / ${teams.length}<br>
          Currently Processing: #${teamNumber} - ${name}
        `;

        let stats = {};
        try {
          stats = await fetchJSON(`https://api.ftcscout.org/rest/v1/teams/${teamNumber}/quick-stats?season=${year}`);
        } catch {}

        const categories = ['tot', 'auto', 'dc', 'eg'];
        const teamData = { teamNumber, name, values: {}, hasData: false, sortValue: -1 };

        for (const cat of categories) {
          const value = stats[cat]?.value;
          const rank = stats[cat]?.rank;
          if (typeof value === 'number' && typeof rank === 'number') {
            teamData.values[cat] = `${value.toFixed(2)} (${toOrdinal(rank)})`;
            teamData.hasData = true;
            if (cat === sortMethod) teamData.sortValue = value;
          } else {
            teamData.values[cat] = "No Statistics Available";
          }
        }

        teamStatsList.push(teamData);
      }

      document.getElementById("progress").textContent = "Finished loading all team data.";

      const sorted = teamStatsList.sort((a, b) => {
        if (a.hasData && b.hasData) return b.sortValue - a.sortValue;
        if (a.hasData) return -1;
        if (b.hasData) return 1;
        return 0;
      });

      const table = document.getElementById("rankings");
      table.innerHTML = `
        <tr>
          <th>Rank</th>
          <th>Team</th>
          <th class="${sortMethod === 'tot' ? 'highlight' : ''}">Total</th>
          <th class="${sortMethod === 'auto' ? 'highlight' : ''}">Auto</th>
          <th class="${sortMethod === 'dc' ? 'highlight' : ''}">TeleOP</th>
          <th class="${sortMethod === 'eg' ? 'highlight' : ''}">Endgame</th>
        </tr>
      `;

      sorted.forEach((team, i) => {
        const rank = team.hasData ? toOrdinal(i + 1) : "";
        const teamLink = `https://ftcscout.org/teams/${team.teamNumber}`;
        table.innerHTML += `
          <tr>
            <td>${rank}</td>
            <td><a href="${teamLink}" target="_blank">#${team.teamNumber} - ${team.name}</a></td>
            <td>${team.values.tot}</td>
            <td>${team.values.auto}</td>
            <td>${team.values.dc}</td>
            <td>${team.values.eg}</td>
          </tr>
        `;
      });

      document.getElementById("eventInfo").innerHTML += `<br>Total Teams Scouted: ${teamStatsList.length}`;
    }
  </script>
</body>
</html>
